<!DOCTYPE html>
<html lang="el">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Διαχείριση Αιτήσεων</title>
<style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f2f4f8;
      margin: 0;
      padding: 0;
    }
    .main-container {
      max-width: 1200px;
      margin: 30px auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .logo {
      height: 70px;
    }
    .school-info {
      text-align: right;
    }
    .school-info p {
      margin: 0;
      font-weight: bold;
    }
    .logout-btn {
      background: #6c757d;
      color: white;
      padding: 6px 14px;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      text-decoration: none;
    }
    h1 { text-align: center; color: #333; }
    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px;
      border: 1px solid #ddd;
      text-align: center;
    }
    th { background: #f5f5f5; }
    .form-button {
      background: #17a2b8;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 6px;
      font-size: 13px;
      margin: 2px;
    }
    select {
      padding: 6px 10px;
      border-radius: 6px;
      font-weight: bold;
      color: white;
      border: none;
      outline: none;
    }
    .btn {
      padding: 6px 10px;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
    }
    .modal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.4);
}

.modal-content {
  background-color: #fff;
  margin: 5% auto;
  padding: 20px;
  border-radius: 10px;
  width: 90%;
  max-width: 800px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}
.close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
}
</style>
</head>
<body>
<div class="main-container">
<div class="header">
<img alt="Πανεπιστήμιο" class="logo" src="unofpel.png"/>
<div class="school-info">
<p>ΣΧΟΛΗ ΟΙΚΟΝΟΜΙΑΣ ΚΑΙ ΤΕΧΝΟΛΟΓΙΑΣ</p>
<p>ΤΜΗΜΑ ΨΗΦΙΑΚΩΝ ΣΥΣΤΗΜΑΤΩΝ</p>
</div>
<a class="logout-btn" href="login.html">Αποσύνδεση</a>
</div>
<h1>Διαχείριση Αιτήσεων</h1>
<button onclick="deleteAllApplications()" style="background-color: #c0392b; color: white; padding: 10px 15px; border: none; border-radius: 6px; font-size: 15px; margin-bottom: 20px;">🗑️ Διαγραφή Όλων των Αιτήσεων</button>
<table>
<thead>
<tr>
<th>ΑΑ</th>
<th>Ονοματεπώνυμο</th>
<th>Ημ/νία</th>
<th>Κατάσταση</th>
<th>Σχόλια</th>
<th>Αρχεία</th>
</tr>
</thead>

<div class="status-container">
  <h3>Ιστορικό Αίτησης:</h3>
  <ul id="log-history"></ul>
</div>

<tbody id="application-body"></tbody>
</table>
</div>
<div class="modal" id="form-viewer">
<div class="modal-content">
<span class="close" onclick="closeFormViewer()">×</span>
<div id="form-content" style="max-height: 60vh; overflow-y: auto;"></div>
</div>
</div>
<script>
function loadApplications() {
  const tableBody = document.getElementById('application-body');
  tableBody.innerHTML = '';
  const studentIds = new Set();

  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key.startsWith("student_") && key.endsWith("_data")) {
      studentIds.add(key.split("_")[1]);
    } else if (key.startsWith("up_dilwsh_data_")) {
      studentIds.add(key.replace("up_dilwsh_data_", ""));
    } else if (key.startsWith("vevaiwsi_apodoxis_data_")) {
      studentIds.add(key.replace("vevaiwsi_apodoxis_data_", ""));
    }
  }

  let index = 1;
  const processedIds = new Set();

  for (const studentId of studentIds) {
    if (processedIds.has(studentId)) continue;

    const allEntries = [];
    const studentData = JSON.parse(localStorage.getItem(`student_${studentId}_data`) || "null");
    const upDilwshData = JSON.parse(localStorage.getItem(`up_dilwsh_data_${studentId}`) || "null");
    const vevaiwsiData = JSON.parse(localStorage.getItem(`vevaiwsi_apodoxis_data_${studentId}`) || "null");

    if (studentData) allEntries.push({ data: studentData });
    if (upDilwshData) allEntries.push({ data: upDilwshData });
    if (vevaiwsiData) allEntries.push({ data: vevaiwsiData });

    if (allEntries.length === 0) continue;

    allEntries.sort((a, b) => new Date(a.data.current_date || 0) - new Date(b.data.current_date || 0));
    const latestEntry = allEntries[allEntries.length - 1].data;

    const name = latestEntry.stud_name || '-';
    const surname = latestEntry.stud_surname || '-';
    if (name === "-" && surname === "-") continue;

    const dateRaw = latestEntry.current_date;
    const date = dateRaw ? new Date(dateRaw).toLocaleString('el-GR') : '-';

    const status = localStorage.getItem(`student_${studentId}_status`) || 'Pending';
    const comments = localStorage.getItem(`student_${studentId}_comments`) || '';

    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${index++}</td>
      <td>${name} ${surname}</td>
      <td>${date}</td>
      <td>
        <select id="status_${studentId}" onchange="updateStatus('${studentId}')">
          <option value="Pending" ${status === 'Pending' ? 'selected' : ''}>Εκκρεμεί</option>
          <option value="ApprovedByAdmin" ${status === 'ApprovedByAdmin' ? 'selected' : ''}>Εγκεκριμένη</option>
          <option value="Rejected" ${status === 'Rejected' ? 'selected' : ''}>Απορριφθείσα</option>
        </select>
      </td>
      <td>
        <textarea id="comment_${studentId}" rows="3">${comments}</textarea>
        <button class="btn" style="background: #28a745; color: white;" onclick="saveStatus('${studentId}')">💾 Αποθήκευση</button>
      </td>
      <td>
        <span>ΥΔ: ${localStorage.getItem(`up_dilwsh_html_${studentId}`) ? '✔️' : '❌'}</span><br/>
        <span>Βεβ: ${localStorage.getItem(`vevaiwsi_apodoxis_html_${studentId}`) ? '✔️' : '❌'}</span><br/>
        <button class="form-button" onclick="viewForm('${studentId}', 'up_dilwsh')">Προβολή ΥΔ</button>
        <button class="form-button" onclick="viewForm('${studentId}', 'vevaiwsi_apodoxis')">Προβολή Βεβαίωσης</button>
      </td>
    `;
    tableBody.appendChild(row);
    updateStatus(studentId);
    processedIds.add(studentId);
  }
}

function updateStatus(studentId) {
  const selectEl = document.getElementById('status_' + studentId);
  const value = selectEl.value;
  let bgColor = '#ffc107';
  if (value === 'Approved') bgColor = '#28a745';
  else if (value === 'Rejected') bgColor = '#dc3545';

  selectEl.style.backgroundColor = bgColor;
  selectEl.style.color = '#fff';
}

function saveStatus(studentId) {
  const status = document.getElementById('status_' + studentId).value;
  const comments = document.getElementById('comment_' + studentId).value;
  localStorage.setItem(`student_${studentId}_status`, status);
  localStorage.setItem(`student_${studentId}_comments`, comments);
  alert("Η κατάσταση και τα σχόλια αποθηκεύτηκαν.");


const logs = JSON.parse(localStorage.getItem(`student_${studentId}_log`) || "[]");
logs.push({
    action: status === "ApprovedByAdmin" ? "Εγκρίθηκε από Γραμματεία" : "Απορρίφθηκε από Γραμματεία",
    by: "Γραμματεία",
    comment: comments,
    date: new Date().toLocaleString("el-GR")
});
localStorage.setItem(`student_${studentId}_log`, JSON.stringify(logs));


}

function viewForm(studentId, type) {
  let template = '';
  const studentData = JSON.parse(localStorage.getItem(`student_${studentId}_data`) || "{}");
  const upDilwshData = JSON.parse(localStorage.getItem(`up_dilwsh_data_${studentId}`) || "{}");
  const vevaiwsiData = JSON.parse(localStorage.getItem(`vevaiwsi_apodoxis_data_${studentId}`) || "{}");

  if (type === 'up_dilwsh') {
    template = localStorage.getItem('up_dilwsh') || '<p>Δεν υπάρχει πρότυπο ΥΔ.</p>';
  } else if (type === 'vevaiwsi_apodoxis') {
    template = localStorage.getItem('vevaiwsi_apodoxis') || '<p>Δεν υπάρχει πρότυπο Βεβαίωσης.</p>';
  }

  const mergedData = { ...studentData, ...upDilwshData, ...vevaiwsiData };
  mergedData.org = vevaiwsiData.emp_name || '';
  mergedData.addr = vevaiwsiData.emp_addr || '';
  mergedData.repr = vevaiwsiData.emp_sup || '';
  const filled = template.replace(/{{\s*(\w+)\s*}}/g, (match, key) => mergedData[key] || `[${key}]`);

  document.getElementById("form-content").innerHTML = '<div class="document-preview">' + filled + '</div>';
  document.getElementById("form-viewer").style.display = "flex";
}

function showDocumentPreview(key, title) {
  const studentId = localStorage.getItem('active_student_id');
  const studentData = JSON.parse(localStorage.getItem('student_' + studentId + '_data') || '{}');
  const vevaiwsiData = JSON.parse(localStorage.getItem('vevaiwsi_apodoxis_data_' + studentId) || '{}');
  const updilwshData = JSON.parse(localStorage.getItem('up_dilwsh_data_' + studentId) || '{}');

  const merged = {
    ...studentData,
    ...vevaiwsiData,
    ...updilwshData
  };
  

  // Εναλλακτικά aliases (αν υπάρχουν στο template)
  merged.org = vevaiwsiData.emp_name;
  merged.addr = vevaiwsiData.emp_addr;
  merged.repr = vevaiwsiData.emp_sup;

  const template = localStorage.getItem(key);
  const filled = template.replace(/{{\\s*(\\w+)\\s*}}/g, (match, key) => merged[key] || `[${key}]`);

  const modal = document.getElementById('documentModal');
  const modalTitle = document.getElementById('modalTitle');
  const documentPreview = document.getElementById('documentPreview');

  modalTitle.textContent = title;
  documentPreview.innerHTML = filled;
  modal.style.display = 'block';
}

function closeFormViewer() {
  document.getElementById("form-viewer").style.display = "none";


  const logList = document.getElementById("log-history");
logList.innerHTML = "";

const logs = JSON.parse(localStorage.getItem(`student_${studentId}_log`) || "[]");

logs.forEach(entry => {
  const li = document.createElement("li");
  li.textContent = `${entry.date} — ${entry.by}: ${entry.action}` + (entry.comment ? ` (${entry.comment})` : "");
  logList.appendChild(li);
});

}

function deleteAllApplications() {
  if (confirm("Είσαι σίγουρος ότι θέλεις να διαγράψεις ΟΛΕΣ τις αιτήσεις;")) {
    const keysToDelete = [];
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (
        key.startsWith("student_") ||
        key.startsWith("up_dilwsh_") ||
        key.startsWith("vevaiwsi_apodoxis_") ||
        key.startsWith("temp_form_data_")
      ) {
        keysToDelete.push(key);
      }
    }
    keysToDelete.forEach(key => localStorage.removeItem(key));
    alert("🗑️ Όλες οι αιτήσεις διαγράφηκαν!");
    loadApplications();
  }
}

document.addEventListener('DOMContentLoaded', loadApplications);
</script>
</body>
</html>
