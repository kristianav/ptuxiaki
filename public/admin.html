<!DOCTYPE html>
<html lang="el">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î‘Î¹Ï„Î®ÏƒÎµÏ‰Î½</title>
<style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f2f4f8;
      margin: 0;
      padding: 0;
    }
    .main-container {
      max-width: 1200px;
      margin: 30px auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .logo {
      height: 70px;
    }
    .school-info {
      text-align: right;
    }
    .school-info p {
      margin: 0;
      font-weight: bold;
    }
    .logout-btn {
      background: #6c757d;
      color: white;
      padding: 6px 14px;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      text-decoration: none;
    }
    h1 { text-align: center; color: #333; }
    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px;
      border: 1px solid #ddd;
      text-align: center;
    }
    th { background: #f5f5f5; }
    .form-button {
      background: #17a2b8;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 6px;
      font-size: 13px;
      margin: 2px;
    }
    select {
      padding: 6px 10px;
      border-radius: 6px;
      font-weight: bold;
      color: white;
      border: none;
      outline: none;
    }
    .btn {
      padding: 6px 10px;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
    }
    .modal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.4);
}

.modal-content {
  background-color: #fff;
  margin: 5% auto;
  padding: 20px;
  border-radius: 10px;
  width: 90%;
  max-width: 800px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}
.close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
}
</style>
</head>
<body>
<div class="main-container">
<div class="header">
<img alt="Î Î±Î½ÎµÏ€Î¹ÏƒÏ„Î®Î¼Î¹Î¿" class="logo" src="unofpel.png"/>
<div class="school-info">
<p>Î£Î§ÎŸÎ›Î— ÎŸÎ™ÎšÎŸÎÎŸÎœÎ™Î‘Î£ ÎšÎ‘Î™ Î¤Î•Î§ÎÎŸÎ›ÎŸÎ“Î™Î‘Î£</p>
<p>Î¤ÎœÎ—ÎœÎ‘ Î¨Î—Î¦Î™Î‘ÎšÎ©Î Î£Î¥Î£Î¤Î—ÎœÎ‘Î¤Î©Î</p>
</div>
<a class="logout-btn" href="login.html">Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·</a>
</div>
<h1>Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î‘Î¹Ï„Î®ÏƒÎµÏ‰Î½</h1>
<button onclick="deleteAllApplications()" style="background-color: #c0392b; color: white; padding: 10px 15px; border: none; border-radius: 6px; font-size: 15px; margin-bottom: 20px;">ğŸ—‘ï¸ Î”Î¹Î±Î³ÏÎ±Ï†Î® ÎŒÎ»Ï‰Î½ Ï„Ï‰Î½ Î‘Î¹Ï„Î®ÏƒÎµÏ‰Î½</button>
<table>
<thead>
<tr>
<th>Î‘Î‘</th>
<th>ÎŸÎ½Î¿Î¼Î±Ï„ÎµÏ€ÏÎ½Ï…Î¼Î¿</th>
<th>Î—Î¼/Î½Î¯Î±</th>
<th>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</th>
<th>Î£Ï‡ÏŒÎ»Î¹Î±</th>
<th>Î‘ÏÏ‡ÎµÎ¯Î±</th>
</tr>
</thead>

<div class="status-container">
  <h3>Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Î‘Î¯Ï„Î·ÏƒÎ·Ï‚:</h3>
  <ul id="log-history"></ul>
</div>

<tbody id="application-body"></tbody>
</table>
</div>
<div class="modal" id="form-viewer">
<div class="modal-content">
<span class="close" onclick="closeFormViewer()">Ã—</span>
<div id="form-content" style="max-height: 60vh; overflow-y: auto;"></div>
</div>
</div>
<script>
function loadApplications() {
  const tableBody = document.getElementById('application-body');
  tableBody.innerHTML = '';
  const studentIds = new Set();

  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key.startsWith("student_") && key.endsWith("_data")) {
      studentIds.add(key.split("_")[1]);
    } else if (key.startsWith("up_dilwsh_data_")) {
      studentIds.add(key.replace("up_dilwsh_data_", ""));
    } else if (key.startsWith("vevaiwsi_apodoxis_data_")) {
      studentIds.add(key.replace("vevaiwsi_apodoxis_data_", ""));
    }
  }

  let index = 1;
  const processedIds = new Set();

  for (const studentId of studentIds) {
    if (processedIds.has(studentId)) continue;

    const allEntries = [];
    const studentData = JSON.parse(localStorage.getItem(`student_${studentId}_data`) || "null");
    const upDilwshData = JSON.parse(localStorage.getItem(`up_dilwsh_data_${studentId}`) || "null");
    const vevaiwsiData = JSON.parse(localStorage.getItem(`vevaiwsi_apodoxis_data_${studentId}`) || "null");

    if (studentData) allEntries.push({ data: studentData });
    if (upDilwshData) allEntries.push({ data: upDilwshData });
    if (vevaiwsiData) allEntries.push({ data: vevaiwsiData });

    if (allEntries.length === 0) continue;

    allEntries.sort((a, b) => new Date(a.data.current_date || 0) - new Date(b.data.current_date || 0));
    const latestEntry = allEntries[allEntries.length - 1].data;

    const name = latestEntry.stud_name || '-';
    const surname = latestEntry.stud_surname || '-';
    if (name === "-" && surname === "-") continue;

    const dateRaw = latestEntry.current_date;
    const date = dateRaw ? new Date(dateRaw).toLocaleString('el-GR') : '-';

    const status = localStorage.getItem(`student_${studentId}_status`) || 'Pending';
    const comments = localStorage.getItem(`student_${studentId}_comments`) || '';

    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${index++}</td>
      <td>${name} ${surname}</td>
      <td>${date}</td>
      <td>
        <select id="status_${studentId}" onchange="updateStatus('${studentId}')">
          <option value="Pending" ${status === 'Pending' ? 'selected' : ''}>Î•ÎºÎºÏÎµÎ¼ÎµÎ¯</option>
          <option value="ApprovedByAdmin" ${status === 'ApprovedByAdmin' ? 'selected' : ''}>Î•Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î·</option>
          <option value="Rejected" ${status === 'Rejected' ? 'selected' : ''}>Î‘Ï€Î¿ÏÏÎ¹Ï†Î¸ÎµÎ¯ÏƒÎ±</option>
        </select>
      </td>
      <td>
        <textarea id="comment_${studentId}" rows="3">${comments}</textarea>
        <button class="btn" style="background: #28a745; color: white;" onclick="saveStatus('${studentId}')">ğŸ’¾ Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
      </td>
      <td>
        <span>Î¥Î”: ${localStorage.getItem(`up_dilwsh_html_${studentId}`) ? 'âœ”ï¸' : 'âŒ'}</span><br/>
        <span>Î’ÎµÎ²: ${localStorage.getItem(`vevaiwsi_apodoxis_html_${studentId}`) ? 'âœ”ï¸' : 'âŒ'}</span><br/>
        <button class="form-button" onclick="viewForm('${studentId}', 'up_dilwsh')">Î ÏÎ¿Î²Î¿Î»Î® Î¥Î”</button>
        <button class="form-button" onclick="viewForm('${studentId}', 'vevaiwsi_apodoxis')">Î ÏÎ¿Î²Î¿Î»Î® Î’ÎµÎ²Î±Î¯Ï‰ÏƒÎ·Ï‚</button>
      </td>
    `;
    tableBody.appendChild(row);
    updateStatus(studentId);
    processedIds.add(studentId);
  }
}

function updateStatus(studentId) {
  const selectEl = document.getElementById('status_' + studentId);
  const value = selectEl.value;
  let bgColor = '#ffc107';
  if (value === 'Approved') bgColor = '#28a745';
  else if (value === 'Rejected') bgColor = '#dc3545';

  selectEl.style.backgroundColor = bgColor;
  selectEl.style.color = '#fff';
}

function saveStatus(studentId) {
  const status = document.getElementById('status_' + studentId).value;
  const comments = document.getElementById('comment_' + studentId).value;
  localStorage.setItem(`student_${studentId}_status`, status);
  localStorage.setItem(`student_${studentId}_comments`, comments);
  alert("Î— ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· ÎºÎ±Î¹ Ï„Î± ÏƒÏ‡ÏŒÎ»Î¹Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎ±Î½.");


const logs = JSON.parse(localStorage.getItem(`student_${studentId}_log`) || "[]");
logs.push({
    action: status === "ApprovedByAdmin" ? "Î•Î³ÎºÏÎ¯Î¸Î·ÎºÎµ Î±Ï€ÏŒ Î“ÏÎ±Î¼Î¼Î±Ï„ÎµÎ¯Î±" : "Î‘Ï€Î¿ÏÏÎ¯Ï†Î¸Î·ÎºÎµ Î±Ï€ÏŒ Î“ÏÎ±Î¼Î¼Î±Ï„ÎµÎ¯Î±",
    by: "Î“ÏÎ±Î¼Î¼Î±Ï„ÎµÎ¯Î±",
    comment: comments,
    date: new Date().toLocaleString("el-GR")
});
localStorage.setItem(`student_${studentId}_log`, JSON.stringify(logs));


}

function viewForm(studentId, type) {
  let template = '';
  const studentData = JSON.parse(localStorage.getItem(`student_${studentId}_data`) || "{}");
  const upDilwshData = JSON.parse(localStorage.getItem(`up_dilwsh_data_${studentId}`) || "{}");
  const vevaiwsiData = JSON.parse(localStorage.getItem(`vevaiwsi_apodoxis_data_${studentId}`) || "{}");

  if (type === 'up_dilwsh') {
    template = localStorage.getItem('up_dilwsh') || '<p>Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï€ÏÏŒÏ„Ï…Ï€Î¿ Î¥Î”.</p>';
  } else if (type === 'vevaiwsi_apodoxis') {
    template = localStorage.getItem('vevaiwsi_apodoxis') || '<p>Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï€ÏÏŒÏ„Ï…Ï€Î¿ Î’ÎµÎ²Î±Î¯Ï‰ÏƒÎ·Ï‚.</p>';
  }

  const mergedData = { ...studentData, ...upDilwshData, ...vevaiwsiData };
  mergedData.org = vevaiwsiData.emp_name || '';
  mergedData.addr = vevaiwsiData.emp_addr || '';
  mergedData.repr = vevaiwsiData.emp_sup || '';
  const filled = template.replace(/{{\s*(\w+)\s*}}/g, (match, key) => mergedData[key] || `[${key}]`);

  document.getElementById("form-content").innerHTML = '<div class="document-preview">' + filled + '</div>';
  document.getElementById("form-viewer").style.display = "flex";
}

function showDocumentPreview(key, title) {
  const studentId = localStorage.getItem('active_student_id');
  const studentData = JSON.parse(localStorage.getItem('student_' + studentId + '_data') || '{}');
  const vevaiwsiData = JSON.parse(localStorage.getItem('vevaiwsi_apodoxis_data_' + studentId) || '{}');
  const updilwshData = JSON.parse(localStorage.getItem('up_dilwsh_data_' + studentId) || '{}');

  const merged = {
    ...studentData,
    ...vevaiwsiData,
    ...updilwshData
  };
  

  // Î•Î½Î±Î»Î»Î±ÎºÏ„Î¹ÎºÎ¬ aliases (Î±Î½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÏƒÏ„Î¿ template)
  merged.org = vevaiwsiData.emp_name;
  merged.addr = vevaiwsiData.emp_addr;
  merged.repr = vevaiwsiData.emp_sup;

  const template = localStorage.getItem(key);
  const filled = template.replace(/{{\\s*(\\w+)\\s*}}/g, (match, key) => merged[key] || `[${key}]`);

  const modal = document.getElementById('documentModal');
  const modalTitle = document.getElementById('modalTitle');
  const documentPreview = document.getElementById('documentPreview');

  modalTitle.textContent = title;
  documentPreview.innerHTML = filled;
  modal.style.display = 'block';
}

function closeFormViewer() {
  document.getElementById("form-viewer").style.display = "none";


  const logList = document.getElementById("log-history");
logList.innerHTML = "";

const logs = JSON.parse(localStorage.getItem(`student_${studentId}_log`) || "[]");

logs.forEach(entry => {
  const li = document.createElement("li");
  li.textContent = `${entry.date} â€” ${entry.by}: ${entry.action}` + (entry.comment ? ` (${entry.comment})` : "");
  logList.appendChild(li);
});

}

function deleteAllApplications() {
  if (confirm("Î•Î¯ÏƒÎ±Î¹ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Ï‚ ÏŒÏ„Î¹ Î¸Î­Î»ÎµÎ¹Ï‚ Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÎ¹Ï‚ ÎŸÎ›Î•Î£ Ï„Î¹Ï‚ Î±Î¹Ï„Î®ÏƒÎµÎ¹Ï‚;")) {
    const keysToDelete = [];
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (
        key.startsWith("student_") ||
        key.startsWith("up_dilwsh_") ||
        key.startsWith("vevaiwsi_apodoxis_") ||
        key.startsWith("temp_form_data_")
      ) {
        keysToDelete.push(key);
      }
    }
    keysToDelete.forEach(key => localStorage.removeItem(key));
    alert("ğŸ—‘ï¸ ÎŒÎ»ÎµÏ‚ Î¿Î¹ Î±Î¹Ï„Î®ÏƒÎµÎ¹Ï‚ Î´Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎ±Î½!");
    loadApplications();
  }
}

document.addEventListener('DOMContentLoaded', loadApplications);
</script>
</body>
</html>
