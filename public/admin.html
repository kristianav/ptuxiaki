<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Διαχείριση Αιτήσεων</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f2f4f8;
      margin: 0;
      padding: 0;
    }
    .main-container {
      max-width: 1200px;
      margin: 30px auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .logo {
      height: 70px;
    }
    .school-info {
      text-align: right;
    }
    .school-info p {
      margin: 0;
      font-weight: bold;
    }
    .logout-btn {
      background: #6c757d;
      color: white;
      padding: 6px 14px;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      text-decoration: none;
    }
    h1 { text-align: center; color: #333; }
    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px;
      border: 1px solid #ddd;
      text-align: center;
    }
    th { background: #f5f5f5; }
    .form-button {
      background: #17a2b8;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 6px;
      font-size: 13px;
      margin: 2px;
    }
    select {
      padding: 6px 10px;
      border-radius: 6px;
      font-weight: bold;
      color: white;
      border: none;
      outline: none;
    }
    #form-viewer {
      display: none;
      position: fixed;
      z-index: 2000;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      width: 80%;
      max-width: 800px;
      position: relative;
    }
    .close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 22px;
      color: #999;
      cursor: pointer;
    }
    textarea {
      width: 95%;
      padding: 6px;
      border-radius: 5px;
      font-size: 13px;
    }
    .btn {
      padding: 6px 10px;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="main-container">
    <div class="header">
      <img src="unofpel.png" class="logo" alt="Πανεπιστήμιο">
      <div class="school-info">
        <p>ΣΧΟΛΗ ΟΙΚΟΝΟΜΙΑΣ ΚΑΙ ΤΕΧΝΟΛΟΓΙΑΣ</p>
        <p>ΤΜΗΜΑ ΨΗΦΙΑΚΩΝ ΣΥΣΤΗΜΑΤΩΝ</p>
      </div>
      <a href="login.html" class="logout-btn">Αποσύνδεση</a>
    </div>

    <h1>Διαχείριση Αιτήσεων</h1>
    <table>
      <thead>
        <tr>
          <th>ΑΑ</th>
          <th>Ονοματεπώνυμο</th>
          <th>Ημ/νία</th>
          <th>Κατάσταση</th>
          <th>Σχόλια</th>
          <th>Αρχεία</th>
        </tr>
      </thead>
      <tbody id="application-body"></tbody>
    </table>
  </div>

  <div id="form-viewer" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeFormViewer()">&times;</span>
      <div id="form-content" style="max-height: 60vh; overflow-y: auto;"></div>
    </div>
  </div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  loadApplications();
});

function loadApplications() {
  const aitisi = JSON.parse(localStorage.getItem('aitisi_form_data'));
  const status = localStorage.getItem('application_status') || 'Pending';
  const comments = localStorage.getItem('secretary_comments') || '';

  const tableBody = document.getElementById('application-body');
  tableBody.innerHTML = '';

  if (aitisi) {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>1</td>
      <td>${aitisi.stud_name} ${aitisi.stud_surname}</td>
      <td>${aitisi['current-date']}</td>
      <td>
        <select id="status-select" onchange="updateStatus(this)" style="padding: 6px 10px; border-radius: 6px; font-weight: bold; border: none; color: white;">
          <option value="Pending">Εκκρεμεί</option>
          <option value="Approved">Εγκεκριμένη</option>
          <option value="Rejected">Απορριφθείσα</option>
        </select>
      </td>
      <td>
        <textarea id="comment-box" placeholder="Σχόλια..." rows="3" style="width: 95%; padding: 6px; border-radius: 5px; font-size: 13px;"></textarea>
        <button id="save-btn" class="btn" style="margin-top: 5px; background: #28a745; color: white; display: none;" onclick="saveStatus()">💾 Αποθήκευση</button>
      </td>
      <td>
        <button class="form-button" onclick="viewForm('dilwsh')">Υπεύθυνη Δήλωση</button>
        <button class="form-button" onclick="viewForm('vevaiwsh')">Βεβαίωση Αποδοχής</button>
      </td>
    `;
    tableBody.appendChild(row);

    const select = document.getElementById('status-select');
    select.value = status;
    updateStatus(select);

    const textarea = document.getElementById('comment-box');
    const saveBtn = document.getElementById('save-btn');
    textarea.value = comments;
    saveBtn.style.display = 'none';

    textarea.addEventListener('input', () => {
      saveBtn.style.display = textarea.value !== comments ? 'inline-block' : 'none';
    });
  }
}

function updateStatus(selectEl) {
  const value = selectEl.value;
  localStorage.setItem('application_status', value);

  let bgColor = '#ffc107'; // Εκκρεμεί
  if (value === 'Approved') bgColor = '#28a745';
  else if (value === 'Rejected') bgColor = '#dc3545';

  selectEl.style.backgroundColor = bgColor;
  selectEl.style.color = '#fff';
}

function saveStatus() {
  const status = document.getElementById('status-select').value;
  const comments = document.getElementById('comment-box').value;
  localStorage.setItem('application_status', status);
  localStorage.setItem('secretary_comments', comments);
  document.getElementById('save-btn').style.display = 'none';
  alert("Η κατάσταση και τα σχόλια αποθηκεύτηκαν.");
}

function viewForm(type) {
  let template = '';
  let data = {};

  if (type === 'dilwsh') {
    template = localStorage.getItem('up_dilwsh') || 'Δεν έχει υποβληθεί δήλωση.';
    data = JSON.parse(localStorage.getItem('up_dilwsh_data')) || {};
  } else if (type === 'vevaiwsh') {
    template = localStorage.getItem('vevaiwsi_apodoxis') || 'Δεν έχει υποβληθεί βεβαίωση.';
    data = JSON.parse(localStorage.getItem('vevaiwsi_apodoxis_data')) || {};
  } else if (type === 'aitisi') {
    const aitisiData = JSON.parse(localStorage.getItem('aitisi_form_data')) || {};
    let html = '<h3>Κύρια Αίτηση</h3><ul>';
    for (const key in aitisiData) {
      html += `<li><strong>${key}:</strong> ${aitisiData[key]}</li>`;
    }
    html += '</ul>';
    document.getElementById('form-content').innerHTML = html;
    document.getElementById('form-viewer').style.display = 'flex';
    return;
  }

  const filled = template.replace(/{{\s*(\w+)\s*}}/g, (match, key) => data[key] || '');
  document.getElementById('form-content').innerHTML = `<div class="document-preview">${filled}</div>`;
  document.getElementById('form-viewer').style.display = 'flex';
}

function closeFormViewer() {
  document.getElementById('form-viewer').style.display = 'none';
}
</script>

</body>
</html>
